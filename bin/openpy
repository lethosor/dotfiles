#! /usr/bin/env python
import argparse, importlib, os, subprocess, sys
PY_VERSION = '.'.join(list(str(i) for i in sys.version_info)[:2])
parser = argparse.ArgumentParser()
parser.add_argument('module', help='module name')
parser.add_argument('-p', '--path', '--print', action='store_true',
                    help='Display path only')
parser.add_argument('-c', '-e', '-o', '-w', '--command', '--editor', '--with',
                    '--open-with',
                    required=False, help='Command to use to opening file',
                    metavar='editor', dest='editor')
parser.add_argument('-v', '--version', type=str, required=False,
                    help="Python version", default=PY_VERSION)
args = parser.parse_args(sys.argv[1:])
if not PY_VERSION.startswith(args.version):
    py_exec = 'python' + args.version
    try:
        py_path = subprocess.check_output(['which', py_exec]).decode().replace('\n', '').replace('\r', '')
    except subprocess.CalledProcessError:
        print('Python version "%s" not found' % args.version)
        sys.exit(4)
    sys.exit(subprocess.call([py_path] + sys.argv))

editor = args.editor
if editor is None:
    editor = 'open'
    for var in ('OPENPY_EDITOR', 'EDITOR', 'OPEN'):
        if var in os.environ:
            editor = os.environ[var]
            break

try:
    module = importlib.import_module(args.module)
    if not hasattr(module, '__file__'):
        raise TypeError('Does not have a filename (likely built-in)')
    path = module.__file__.replace('.pyc', '.py')
    if args.path:
        print(path)
    else:
        subprocess.call(editor.split() + [path])
except ImportError:
    print('Module "%s" not found' % args.module)
    sys.exit(2)
except Exception as e:
    print('Module "%s" cannot be opened: %s' % (args.module, e))
    sys.exit(3)
