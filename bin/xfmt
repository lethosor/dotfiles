#!/usr/bin/env python3

import argparse
import fnmatch
import os
import pathlib
import subprocess
import tomllib

parser = argparse.ArgumentParser()
parser.add_argument('file')
args = parser.parse_args()

file_path = pathlib.Path(os.path.realpath(args.file))
if not file_path.is_file():
    exit('not a file: %s' % file_path)

def find_configs(path):
    for path in [path] + list(path.parents):
        for f in ('xfmt.toml', '.xfmt.toml'):
            config_path = path / f
            if config_path.exists():
                yield str(config_path)

rules = []

for config_path in find_configs(file_path.parent):
    with open(config_path, 'rb') as f:
        config = tomllib.load(f)

    rules += config.get('rule', [])

    if config.get('isolated'):
        break

matching_rule = next(
    (rule for rule in rules
        if any(fnmatch.fnmatch(file_path, pattern) for pattern in rule["include"])
        and not any(fnmatch.fnmatch(file_path, pattern) for pattern in rule.get("exclude", []))),
    None)
if matching_rule is None:
    exit('no matching rule for file: %s' % file_path)

cmd = matching_rule["command"]
for i, _ in enumerate(cmd):
    if cmd[i] == "$file":
        cmd[i] = str(file_path)

with open(file_path, 'rb') as in_file:
    p = subprocess.run(cmd, stdin=in_file)
    if p.returncode != 0:
        exit('formatter exited with %i' % p.returncode)
